name: Robson Production CI/CD Pipeline

on:
  push:
    branches: ["main"]
    tags:
      - 'v*'  # Trigger on version tags (v0.1.0, v1.0.0, etc.)

permissions:
  contents: write  # Required for pushing manifest updates
  actions: write   # Required for cache-to: type=gha

concurrency:
  group: robson-prod-${{ github.ref }}
  cancel-in-progress: true

env:
  FRONTEND_IMAGE: ldamasio/rbs-frontend-prod
  BACKEND_MONOLITH_IMAGE: ldamasio/rbs-backend-monolith-prod
  BACKEND_NGINX_IMAGE: ldamasio/rbs-backend-nginx-prod

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_PWD }}

      - name: Extract metadata for tagging
        id: meta
        run: |
          # SHA tag (golden standard for production)
          SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
          echo "sha_tag=sha-${SHA_SHORT}" >> $GITHUB_OUTPUT
          
          # Check if this is a release tag
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "version_tag=${VERSION}" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      # ===== FRONTEND =====
      - name: Generate Frontend tags
        id: fe_tags
        run: |
          TAGS="${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.sha_tag }}"
          
          if [[ "${{ steps.meta.outputs.is_release }}" == "true" ]]; then
            TAGS="${TAGS}"$'\n'"${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.version_tag }}"
          fi
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAGS="${TAGS}"$'\n'"${{ env.FRONTEND_IMAGE }}:latest"
          fi
          
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/frontend
          file: ./apps/frontend/docker/Dockerfile
          push: true
          tags: ${{ steps.fe_tags.outputs.tags }}
          build-args: |
            VITE_API_BASE_URL=https://api.robson.rbx.ia.br
            VITE_APP_VERSION=${{ steps.meta.outputs.sha_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ===== BACKEND MONOLITH =====
      - name: Generate Backend Monolith tags
        id: be_tags
        run: |
          TAGS="${{ env.BACKEND_MONOLITH_IMAGE }}:${{ steps.meta.outputs.sha_tag }}"
          
          if [[ "${{ steps.meta.outputs.is_release }}" == "true" ]]; then
            TAGS="${TAGS}"$'\n'"${{ env.BACKEND_MONOLITH_IMAGE }}:${{ steps.meta.outputs.version_tag }}"
          fi
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAGS="${TAGS}"$'\n'"${{ env.BACKEND_MONOLITH_IMAGE }}:latest"
          fi
          
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push Backend Monolith image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend/monolith
          file: ./apps/backend/monolith/docker/Dockerfile_django
          push: true
          tags: ${{ steps.be_tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ===== BACKEND NGINX =====
      - name: Generate Backend Nginx tags
        id: nx_tags
        run: |
          TAGS="${{ env.BACKEND_NGINX_IMAGE }}:${{ steps.meta.outputs.sha_tag }}"
          
          if [[ "${{ steps.meta.outputs.is_release }}" == "true" ]]; then
            TAGS="${TAGS}"$'\n'"${{ env.BACKEND_NGINX_IMAGE }}:${{ steps.meta.outputs.version_tag }}"
          fi
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAGS="${TAGS}"$'\n'"${{ env.BACKEND_NGINX_IMAGE }}:latest"
          fi
          
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push Backend Nginx image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend/monolith
          file: ./apps/backend/monolith/docker/Dockerfile_nginx
          push: true
          tags: ${{ steps.nx_tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ===== GITOPS: UPDATE MANIFESTS =====
      - name: Update K8s manifests with new image tags
        run: |
          SHA_TAG="${{ steps.meta.outputs.sha_tag }}"
          echo "Updating manifests to use: ${SHA_TAG}"
          
          # Update frontend deployment
          sed -i "s|image: ldamasio/rbs-frontend-prod:sha-[a-f0-9]*|image: ldamasio/rbs-frontend-prod:${SHA_TAG}|g" \
            infra/k8s/prod/rbs-frontend-prod-deploy.yml
          
          # Update backend monolith deployment
          sed -i "s|image: ldamasio/rbs-backend-monolith-prod:sha-[a-f0-9]*|image: ldamasio/rbs-backend-monolith-prod:${SHA_TAG}|g" \
            infra/k8s/prod/rbs-backend-monolith-prod-deploy.yml
          
          # Update backend nginx deployment
          sed -i "s|image: ldamasio/rbs-backend-nginx-prod:sha-[a-f0-9]*|image: ldamasio/rbs-backend-nginx-prod:${SHA_TAG}|g" \
            infra/k8s/prod/rbs-backend-nginx-prod-deploy.yml
          
          # Update stop-monitor cronjob (also uses backend image)
          sed -i "s|image: ldamasio/rbs-backend-monolith-prod:.*|image: ldamasio/rbs-backend-monolith-prod:${SHA_TAG}|g" \
            infra/k8s/prod/rbs-stop-monitor-cronjob.yml
          
          echo "âœ… Manifests updated"

      - name: Commit and push manifest changes
        run: |
          SHA_TAG="${{ steps.meta.outputs.sha_tag }}"
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add infra/k8s/prod/*.yml
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No manifest changes to commit"
          else
            git commit -m "chore(gitops): update image tags to ${SHA_TAG}
            
            Automated manifest update by GitHub Actions.
            ArgoCD will automatically sync this change.
            
            [skip ci]"
            
            git push
            echo "âœ… Manifests pushed - ArgoCD will auto-sync"
          fi

      - name: Wait for ArgoCD sync
        env:
          ARGOCD_SERVER: argocd.robson.rbx.ia.br
          ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
        run: |
          # Install ArgoCD CLI
          curl -sSL -o /usr/local/bin/argocd \
            https://github.com/argoproj/argo-cd/releases/download/v2.10.0/argocd-linux-amd64
          chmod +x /usr/local/bin/argocd
          
          # Wait for sync (max 5 minutes)
          echo "â³ Waiting for ArgoCD to sync robson-prod..."
          argocd app wait robson-prod \
            --sync \
            --health \
            --timeout 300 \
            --grpc-web \
            || echo "âš ï¸ ArgoCD sync verification skipped (token not configured)"
          
          echo "âœ… ArgoCD sync step complete"

      - name: Smoke test production
        run: |
          # Wait for pods to be ready
          echo "â³ Waiting 30s for pods to stabilize..."
          sleep 30
          
          # Test frontend responds (with retry)
          for i in 1 2 3; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://app.robson.rbx.ia.br || echo "000")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Frontend smoke test passed: HTTP $HTTP_STATUS"
              exit 0
            fi
            
            echo "âš ï¸ Attempt $i: HTTP $HTTP_STATUS, retrying in 10s..."
            sleep 10
          done
          
          echo "âŒ Frontend smoke test failed after 3 attempts"
          exit 1

      - name: Summary
        run: |
          echo "## ðŸ³ Images Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | SHA Tag | Release Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | \`${{ steps.meta.outputs.sha_tag }}\` | ${{ steps.meta.outputs.is_release == 'true' && format('`{0}`', steps.meta.outputs.version_tag) || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Monolith | \`${{ steps.meta.outputs.sha_tag }}\` | ${{ steps.meta.outputs.is_release == 'true' && format('`{0}`', steps.meta.outputs.version_tag) || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Nginx | \`${{ steps.meta.outputs.sha_tag }}\` | ${{ steps.meta.outputs.is_release == 'true' && format('`{0}`', steps.meta.outputs.version_tag) || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Manifests updated to \`${{ steps.meta.outputs.sha_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ArgoCD sync verified" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production smoke test passed" >> $GITHUB_STEP_SUMMARY
