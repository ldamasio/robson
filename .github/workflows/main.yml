name: Robson Production CI/CD Pipeline

on:
  push:
    branches: ["main"]
    tags:
      - 'v*'  # Trigger on version tags (v0.1.0, v1.0.0, etc.)

permissions:
  contents: read
  actions: write  # Required for cache-to: type=gha

concurrency:
  group: robson-prod-${{ github.ref }}
  cancel-in-progress: true

env:
  FRONTEND_IMAGE: ldamasio/rbs-frontend-prod
  BACKEND_MONOLITH_IMAGE: ldamasio/rbs-backend-monolith-prod
  BACKEND_NGINX_IMAGE: ldamasio/rbs-backend-nginx-prod

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_PWD }}

      - name: Extract metadata for tagging
        id: meta
        run: |
          # SHA tag (golden standard for production)
          SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
          echo "sha_tag=sha-${SHA_SHORT}" >> $GITHUB_OUTPUT
          
          # Check if this is a release tag
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "version_tag=${VERSION}" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      # ===== FRONTEND =====
      - name: Generate Frontend tags
        id: fe_tags
        run: |
          TAGS="${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.sha_tag }}"
          
          if [[ "${{ steps.meta.outputs.is_release }}" == "true" ]]; then
            TAGS="${TAGS}"$'\n'"${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.version_tag }}"
          fi
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAGS="${TAGS}"$'\n'"${{ env.FRONTEND_IMAGE }}:latest"
          fi
          
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/frontend
          file: ./apps/frontend/docker/Dockerfile
          push: true
          tags: ${{ steps.fe_tags.outputs.tags }}
          build-args: |
            VITE_API_BASE_URL=https://api.robson.rbx.ia.br
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ===== BACKEND MONOLITH =====
      - name: Generate Backend Monolith tags
        id: be_tags
        run: |
          TAGS="${{ env.BACKEND_MONOLITH_IMAGE }}:${{ steps.meta.outputs.sha_tag }}"
          
          if [[ "${{ steps.meta.outputs.is_release }}" == "true" ]]; then
            TAGS="${TAGS}"$'\n'"${{ env.BACKEND_MONOLITH_IMAGE }}:${{ steps.meta.outputs.version_tag }}"
          fi
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAGS="${TAGS}"$'\n'"${{ env.BACKEND_MONOLITH_IMAGE }}:latest"
          fi
          
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push Backend Monolith image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend/monolith
          file: ./apps/backend/monolith/docker/Dockerfile_django
          push: true
          tags: ${{ steps.be_tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ===== BACKEND NGINX =====
      - name: Generate Backend Nginx tags
        id: nx_tags
        run: |
          TAGS="${{ env.BACKEND_NGINX_IMAGE }}:${{ steps.meta.outputs.sha_tag }}"
          
          if [[ "${{ steps.meta.outputs.is_release }}" == "true" ]]; then
            TAGS="${TAGS}"$'\n'"${{ env.BACKEND_NGINX_IMAGE }}:${{ steps.meta.outputs.version_tag }}"
          fi
          
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAGS="${TAGS}"$'\n'"${{ env.BACKEND_NGINX_IMAGE }}:latest"
          fi
          
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push Backend Nginx image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend/monolith
          file: ./apps/backend/monolith/docker/Dockerfile_nginx
          push: true
          tags: ${{ steps.nx_tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "## ðŸ³ Images Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | SHA Tag | Release Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | \`${{ steps.meta.outputs.sha_tag }}\` | ${{ steps.meta.outputs.is_release == 'true' && format('`{0}`', steps.meta.outputs.version_tag) || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Monolith | \`${{ steps.meta.outputs.sha_tag }}\` | ${{ steps.meta.outputs.is_release == 'true' && format('`{0}`', steps.meta.outputs.version_tag) || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Nginx | \`${{ steps.meta.outputs.sha_tag }}\` | ${{ steps.meta.outputs.is_release == 'true' && format('`{0}`', steps.meta.outputs.version_tag) || '-' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> âš ï¸ **Production**: Use \`:sha-*\` tags. Update \`infra/k8s/prod/*.yml\` and let ArgoCD sync." >> $GITHUB_STEP_SUMMARY
